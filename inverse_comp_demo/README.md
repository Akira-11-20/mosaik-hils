# ミニHILS逆補償デモ

このサンドボックスは、HILSループで生じる固定観測遅延を逆伝達関数補償でどこまで相殺できるかを、最小構成で手早く試すためのものです。

## 実験フロー

1. 参照入力 `u[k]`（ステップ＋低周波サイン）を生成する。
2. 一次遅れの離散プラント `G(z)` を通して真値 `x[k]` を得る。
3. `x[k]` を整数サンプル遅延＋ガウスノイズに通して `y_delayed[k]` を作る。
4. 補償なしケースとして `y_delayed[k]` をそのまま評価する。
5. 逆補償 `y_comp[k] = a·y[k] - (a-1)·y[k-1]` を適用し、補償後の信号を評価する。

## ブロック図

```
   u[k] ─→ [ Plant G(z) ] ─→ x[k] ─→ [ d-sample delay ] ─→ y_delayed[k]
                                                        │
                              ┌───────────── HILS layer ┴──────────────┐
                              │                                     ┌──┘
                              └── [ Inverse compensator ] ─→ y_comp[k]
                                                        │
                           └───────────── Logging & metrics ─────────┘
```

## デフォルトパラメータ

- サンプリング：`Ts = 0.01 s`（100 Hz）、総シミュレーション時間 `Tend = 20 s`
- 固定遅延：`τ = 0.15 s` ⇒ `d = 15` サンプル
- 逆補償ゲイン：`a = d`
- プラント：一次遅れ `x[k+1] = (1-α) x[k] + α u[k]`（`α = 0.05`）
- ノイズ：`N(0, σ²)`（`σ = 0.001`）

## 計測指標

- 真値 `x[k]` と各観測の追従誤差RMSE
- クロスパワースペクトルから求めたサイン波主要成分の位相遅れ（時間・ラジアン）
- 微分系列どうしの相互相関による遅延推定（サンプル数・ミリ秒）
- ステップ応答の90%到達時間差

## 使い方

```bash
uv run python inverse_comp_demo/run_inverse_comp_demo.py
```

スクリプトは主要指標をコンソールに表示し、真値・遅延波形・補償後波形を比較するプロットを開きます。ノイズ量や遅延サンプル数、プラント設定を直接書き換えて、挙動や安定性を検証してください。

実行時には、グラフが `inverse_comp_demo/inverse_comp_demo.png` として自動保存されます。
