ä»¥ä¸‹ã¯ã€**å®Œå…¨ç‰ˆ MCKFï¼ˆMaximum Correntropy Kalman Filterï¼‰** ã®æ•°å¼ã‚’ã€Œå®Ÿè£…è¨­è¨ˆæ›¸ã€ã¨ã—ã¦ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚
è«–æ–‡ï¼ˆå¼(9)ã€œ(30)ï¼‰ã‚’å®Ÿè£…ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã§ã€æ¦‚å¿µã¨æ•°å­¦çš„æ‰‹é †ã‚’é †åºç«‹ã¦ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

# âœ… å®Ÿè£…çŠ¶æ³ï¼ˆ2025-11-03æ›´æ–°ï¼‰

## ğŸ‰ å®Ÿè£…å®Œäº†ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ | ç²¾åº¦ | ãƒ•ã‚¡ã‚¤ãƒ« |
|-----------|------|------|---------|
| **SimpleMCKF** | âœ… å®Œå…¨å‹•ä½œ | **æ¨™æº–KFã®2.5å€** | [mckf_simple.py](estimators/mckf_simple.py) |
| **Full MCKF** | âœ… å®Œå…¨å‹•ä½œ | **æ¨™æº–KFã®2.3å€** | [mckf.py](estimators/mckf.py) |

### å®Ÿé¨“çµæœ

#### SimpleMCKFï¼ˆé…å»¶ãªã—ã€å¤–ã‚Œå€¤10%ï¼‰

- Standard KF: 0.1918 rad
- SimpleMCKF: **0.0768 rad** â† 2.5å€æ”¹å–„ï¼

#### Full MCKFï¼ˆé…å»¶0-5stepã€å¤–ã‚Œå€¤10%ï¼‰

- Standard KF: 1.2833 rad
- Full MCKF: **0.5485 rad** â† 2.3å€æ”¹å–„ï¼

### æˆåŠŸã®éµ: Information Form + å³å¯†ãªé…å»¶ãƒ¢ãƒ‡ãƒªãƒ³ã‚°

**1. Information Formå®Ÿè£…** (MATLABã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒ):

```python
P_tilde_inv = L_P_inv.T @ T_x @ L_P_inv
R_tilde_inv = L_R_inv.T @ T_y @ L_R_inv
K = inv(C.T @ R_tilde_inv @ C + P_tilde_inv) @ C.T @ R_tilde_inv
```

**2. è«–æ–‡å¼(12)ã«åŸºã¥ãå³å¯†ãªé…å»¶ãƒã‚¤ã‚ºå…±åˆ†æ•£** (2025-11-04è¿½åŠ ):

```python
# RÌ„ = Î£_{t=0}^{k} C*A^t*Q*(A^t)^T*C^T
R_bar = R.copy()
for t in range(delay):
    A_t = np.linalg.matrix_power(A, t)
    R_bar += C @ A_t @ Q @ A_t.T @ C.T

# O = Î£_{t=0}^{k-1} A^t * Q * (A^{k-t-1})^T * C^T
O = np.zeros((n, p))
for t in range(delay):
    A_t = np.linalg.matrix_power(A, t)
    A_k_minus_t_minus_1 = np.linalg.matrix_power(A, delay - t - 1)
    O += A_t @ Q @ A_k_minus_t_minus_1.T @ C_bar.T
```

ã“ã®å³å¯†å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºãŒé…å»¶çµŒç”±ã§è¦³æ¸¬ã«ä¼æ¬ã™ã‚‹åŠ¹æœã‚’å®Œå…¨ã«ãƒ¢ãƒ‡ãƒ«åŒ–ã€‚

è©³ç´°ã¯ [IMPLEMENTATION_GUIDE.md](IMPLEMENTATION_GUIDE.md) ã‚’å‚ç…§ã€‚

---

# ğŸ§­ å…¨ä½“åƒï¼šMCKF ã®è¨­è¨ˆæ€æƒ³

MCKF ã¯ã€é€šå¸¸ã®ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆKFï¼‰ã‚’æ‹¡å¼µã—ã¦ã€

* **ãƒ©ãƒ³ãƒ€ãƒ é…å»¶ãƒ»ãƒ‘ã‚±ãƒƒãƒˆæå¤±**
* **éã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºï¼ˆå¤–ã‚Œå€¤ã‚’å«ã‚€ï¼‰**
  ã®ä¸¡æ–¹ã«é ‘å¥ã«å¯¾å¿œã•ã›ã‚‹æ‰‹æ³•ã§ã™ã€‚

æ‰‹é †ã¯å¤§ããä»¥ä¸‹ã® 3 æ®µéšã§ã™ï¼š

| æ®µéš | å‡¦ç†                      | ä¸»ãªå¼ï¼ˆè«–æ–‡ï¼‰   |
| -- | ----------------------- | --------- |
| â‘   | kã‚¹ãƒ†ãƒƒãƒ—é…å»¶ãƒ»æå¤±ã‚’é…å»¶ãªã—ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›   | (3)ã€œ(13)  |
| â‘¡  | ãƒã‚¤ã‚ºç›¸é–¢ã‚’é™¤å»ã—ã¦ã‚«ãƒ«ãƒãƒ³ä»®å®šã‚’å›å¾©     | (14)ã€œ(17) |
| â‘¢  | æœ€å¤§ã‚³ãƒ¬ãƒ³ãƒ­ãƒ”ãƒ¼åŸºæº–ã§ãƒ­ãƒã‚¹ãƒˆæ¨å®šï¼ˆMCKFï¼‰ | (24)ã€œ(30) |

---

# âš™ï¸ â‘  é…å»¶ãƒ»æå¤±ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰ï¼ˆBernoulliåˆ†å¸ƒï¼‰

å„æ™‚åˆ»ã§ãƒ‡ãƒ¼ã‚¿ãŒå±Šãç¢ºç‡ã‚’ãƒ™ãƒ«ãƒŒãƒ¼ã‚¤å¤‰æ•°ã§è¡¨ã™ï¼š

$$
\Lambda_{i,n} =
\begin{cases}
1, & \text{if data delayed by } i \text{ steps}\
0, & \text{otherwise}
\end{cases}
$$

* $i = 0$: é…å»¶ãªã—
* (i = 1, 2, â€¦, k): (i)-ã‚¹ãƒ†ãƒƒãƒ—é…å»¶
* $i = k+1$: ãƒ‘ã‚±ãƒƒãƒˆæå¤±ï¼ˆå®Œå…¨æ¬ æï¼‰

---

## (1) çŠ¶æ…‹æ–¹ç¨‹å¼ãƒ»è¦³æ¸¬æ–¹ç¨‹å¼ï¼ˆé…å»¶å«ã‚€ï¼‰

$$
x_{n+1} = Bx_n + \omega_n, \quad
y_n = Cx_n + \nu_n
$$

è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã¯é…å»¶ãƒ»æå¤±ã‚’çµŒã¦å—ä¿¡å´ã§æ¬¡ã®ã‚ˆã†ã«è¡¨ã•ã‚Œã‚‹ï¼š

$$
Y_n = \sum_{i=0}^k \Lambda_{i,n} y_{n-i} + \Lambda_{k+1,n} \bar{y}_n
$$

ã“ã“ã§ (\bar{y}*n = C B \hat{x}*{n-1}) ã¯**äºˆæ¸¬è¦³æ¸¬å€¤**ï¼ˆæ¬ æè£œå®Œç”¨ï¼‰ã€‚

---

## (2) é…å»¶ã‚’å«ã‚€è¦³æ¸¬ã®å†æ§‹æˆï¼ˆé…å»¶ãªã—åŒ–ï¼‰

è¦³æ¸¬æ–¹ç¨‹å¼ã‚’ã€Œé…å»¶ã®ãªã„ã€å½¢ã«å¤‰æ›ï¼š

$$
Y_n = \bar{C}_n x_n + \bar{\nu}_n
$$

ãŸã ã—

$$
\bar{C}*n = \Lambda*{k+1,n} C + \sum_{i=0}^k \Lambda_{i,n} C B^{-i}
$$

$$
\bar{\nu}*n = \Lambda*{k+1,n} \nu_n + \sum_{i=0}^k \Lambda_{i,n} C B^{-i} \omega_{n-i}
$$

ã“ã®ã¨ãã€è¦³æ¸¬é›‘éŸ³ã®å…±åˆ†æ•£ã¯ï¼š

$$
\bar{R}_n = E[\bar{\nu}_n \bar{\nu}_n^T]
$$

ã¾ãŸã€ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºã¨ã®ç›¸é–¢ãŒç”Ÿã˜ã‚‹ï¼š

$$
O_n = E[\omega_n \bar{\nu}_n^T]
$$

---

# ğŸ§© â‘¡ ãƒã‚¤ã‚ºç›¸é–¢ã®é™¤å»ï¼ˆãƒ‡ã‚³ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

é…å»¶ã‚’å«ã‚ã‚‹ã¨ (\omega_n) ã¨ (\bar{\nu}_n) ãŒç›¸é–¢ã™ã‚‹ã€‚
ã“ã‚Œã‚’ **ãƒ©ã‚°ãƒ©ãƒ³ã‚¸ãƒ¥ä¹—æ•°æ³•**ã§ç„¡ç›¸é–¢åŒ–ã™ã‚‹ã€‚

---

## (1) ä¿®æ­£çŠ¶æ…‹æ–¹ç¨‹å¼

æ–°ã—ã„çŠ¶æ…‹æ–¹ç¨‹å¼ã‚’å®šç¾©ï¼š

$$
x_n = D_n x_{n-1} + U_n + \zeta_n
$$

ã“ã“ã§ï¼š

$$
D_n = B - \lambda_n \bar{C}_n B,\quad
U_n = \lambda_n Y_n
$$

(\lambda_n) ã¯ç›¸é–¢ã‚’æ¶ˆã™ãŸã‚ã®ãƒ©ã‚°ãƒ©ãƒ³ã‚¸ãƒ¥ä¹—æ•°ã€‚

---

## (2) æœ€é©ãªãƒ©ã‚°ãƒ©ãƒ³ã‚¸ãƒ¥ä¹—æ•°

$$
\lambda_n = (Q_n \bar{C}_n^T - O_n) (\bar{C}_n Q_n \bar{C}_n^T - O_n^T \bar{C}_n^T)^{-1}
$$

---

## (3) æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹é›‘éŸ³ã¨å…±åˆ†æ•£

$$
\zeta_n = (I - \lambda_n \bar{C}_n)\omega_n + \lambda_n \bar{\nu}_n
$$

$$
Q_{\zeta,n} =
(I - \lambda_n \bar{C}_n)Q_n(I - \lambda_n \bar{C}_n)^T

* \lambda_n \bar{R}_n \lambda_n^T

- (I - \lambda_n \bar{C}_n)O_n \lambda_n^T
- \lambda_n O_n^T (I - \lambda_n \bar{C}_n)^T
  ]

---

# ğŸ§® â‘¢ é…å»¶ãªã— MCKFï¼ˆMaximum Correntropy KFï¼‰

ã“ã‚Œã§é…å»¶ã‚‚ç›¸é–¢ã‚‚å–ã‚Šé™¤ã‹ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒå¾—ã‚‰ã‚ŒãŸï¼š

$$
x_n = D_n x_{n-1} + U_n + \zeta_n, \quad
Y_n = \bar{C}_n x_n + \bar{\nu}_n
$$

ãŸã ã— (\zeta_n, \bar{\nu}_n) ã¯éã‚¬ã‚¦ã‚¹é›‘éŸ³ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ã“ã“ã§ MCKF ã‚’é©ç”¨ã™ã‚‹ã€‚

---

## (1) KFäºˆæ¸¬ã‚¹ãƒ†ãƒƒãƒ—

$$
\hat{x}*n^- = D_n \hat{x}*{n-1} + U_n
$$
$$
P_n^- = D_n P_{n-1} D_n^T + Q_{\zeta,n}
$$

---

## (2) ç™½è‰²åŒ–ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒ‹ãƒ³ã‚°ï¼‰

è¦³æ¸¬ãƒ»äºˆæ¸¬ã‚’ã‚¹ã‚¿ãƒƒã‚¯ï¼š

$$
\begin{bmatrix}
\hat{x}_n^- \ Y_n
\end{bmatrix}
=============

\begin{bmatrix}
I \ \bar{C}_n
\end{bmatrix}
x_n +
\sigma_n
$$

å…±åˆ†æ•£ï¼š
$$
E[\sigma_n \sigma_n^T] =
\begin{bmatrix}
P_n^- & 0 \ 0 & \bar{R}_n
\end{bmatrix}
$$

ã“ã‚Œã‚’ Cholesky åˆ†è§£ã—ã¦ï¼š

$$
L_n L_n^T =
\begin{bmatrix}
P_n^- & 0 \ 0 & \bar{R}_n
\end{bmatrix}
$$

ç™½è‰²åŒ–ã—ãŸãƒ¢ãƒ‡ãƒ«ï¼š

$$
L_n^{-1}
\begin{bmatrix}
\hat{x}_n^- \ Y_n
\end{bmatrix}
=============

L_n^{-1}
\begin{bmatrix}
I \ \bar{C}_n
\end{bmatrix}
x_n + v_n
$$

---

## (3) æœ€å¤§ã‚³ãƒ¬ãƒ³ãƒ­ãƒ”ãƒ¼åŸºæº–ï¼ˆMCCï¼‰

é€šå¸¸ã®æœ€å°äºŒä¹—ã§ã¯ãªãã€**æœ€å¤§ã‚³ãƒ¬ãƒ³ãƒ­ãƒ”ãƒ¼**ã‚’æœ€é©åŒ–ã™ã‚‹ï¼š

$$
J(x_n) = \sum_i \exp\left(-\frac{e_i^2}{2\eta^2}\right)
$$

(\eta)ï¼šãƒãƒ³ãƒ‰å¹…ï¼ˆå¤§â†’ã‚¬ã‚¦ã‚¹ã«è¿‘ã„ï¼Œå°â†’å¤–ã‚Œå€¤æŠ‘åˆ¶ï¼‰

---

## (4) é‡ã¿ä»˜ãç·šå½¢åŒ–

æ®‹å·®ï¼š
$$
e_n = L_n^{-1}([ \hat{x}_n^- ; Y_n ] - [ I ; \bar{C}_n ] \hat{x}_n)
$$

é‡ã¿è¡Œåˆ—ï¼š
$$
T = \mathrm{diag}\left[\exp(-e_i^2/2\eta^2)\right]
$$

åˆ†å‰²ï¼š
$$
T =
\begin{bmatrix}
T_x & 0 \ 0 & T_y
\end{bmatrix}
$$

---

## (5) å†é‡ã¿ä»˜ãå…±åˆ†æ•£

$$
\tilde{P}*n^- = L*{p,n}^{-T} T_x L_{p,n}^{-1}, \quad
\tilde{R}*n   = L*{r,n}^{-T} T_y L_{r,n}^{-1}
$$

ã“ã“ã§ (L_{p,n}, L_{r,n}) ã¯ (P_n^-, \bar{R}_n) ã® Cholesky å› å­ã€‚

---

## (6) MCKFæ›´æ–°å¼

ã‚«ãƒ«ãƒãƒ³ã‚²ã‚¤ãƒ³ï¼š
$$
\tilde{K}_n =
\tilde{P}_n^- \bar{C}_n^T (\bar{C}_n \tilde{P}_n^- \bar{C}_n^T + \tilde{R}_n)^{-1}
$$

çŠ¶æ…‹æ›´æ–°ï¼š
$$
\hat{x}_n = \hat{x}_n^- + \tilde{K}_n (Y_n - \bar{C}_n \hat{x}_n^-)
$$

å…±åˆ†æ•£æ›´æ–°ï¼š
$$
P_n = (I - \tilde{K}_n \bar{C}_n) P_n^- (I - \tilde{K}_n \bar{C}_n)^T + \tilde{K}_n \bar{R}_n \tilde{K}_n^T
$$

---

## (7) åå¾©ï¼ˆIRLSï¼‰

æ®‹å·® (e_n) ã¨é‡ã¿ (T_x,T_y) ã¯ (\hat{x}_n) ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€
1å›ã®æ›´æ–°ã§ã¯è¿‘ä¼¼ã€‚
â†’ æ¬¡ã®ã‚ˆã†ã« **IRLS (Iteratively Reweighted Least Squares)** ã‚’ç¹°ã‚Šè¿”ã™ï¼š

1. äºˆæ¸¬ (\hat{x}_n^-) ã‹ã‚‰åˆæœŸåŒ–
2. (e_n) ã‚’è¨ˆç®—
3. (T_x,T_y) ã‚’æ›´æ–°
4. (\tilde{K}_n,\hat{x}_n,P_n) ã‚’æ›´æ–°
5. åæŸã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ï¼ˆé€šå¸¸2ã€œ5å›ï¼‰

---

# ğŸ“ˆ å®Ÿè£…ä¸Šã®æµã‚Œã¾ã¨ã‚ï¼ˆç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰

```matlab
# 1. å—ä¿¡åˆæˆ Y_n, Cbar, Rbar, O_n (é…å»¶å«ã‚€)
# 2. lambda_n, D_n, U_n, Qzeta (ç›¸é–¢é™¤å»)
# 3. äºˆæ¸¬: x_pred, P_pred
# 4. while not converged:
#       e = L^{-1}([x_pred; Y] - [I; Cbar]*x_est)
#       T = diag(exp(-e.^2/(2*eta^2)))
#       P_tilde = Lp^{-T} T_x Lp^{-1}
#       R_tilde = Lr^{-T} T_y Lr^{-1}
#       K = P_tilde * Cbar' / (Cbar*P_tilde*Cbar' + R_tilde)
#       x_est = x_pred + K*(Y - Cbar*x_pred)
#       P = (I-K*Cbar)*P_pred*(I-K*Cbar)' + K*Rbar*K'
```

---

# ğŸ§  è¨­è¨ˆä¸Šã®ãƒã‚¤ãƒ³ãƒˆ

| è¦ç´              | æ„å‘³ãƒ»åŠ¹æœ               |
| -------------- | ------------------- |
| Bernoulliãƒ¢ãƒ‡ãƒ«   | é€šä¿¡é…å»¶ï¼æå¤±ã‚’ç¢ºç‡çš„ã«ãƒ¢ãƒ‡ãƒ«åŒ–    |
| é…å»¶ãªã—åŒ–          | é…å»¶ã®ã‚ã‚‹è¦³æ¸¬ã‚’1ã¤ã®çµ±ä¸€å¼ã«å¤‰æ›   |
| ãƒ‡ã‚³ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³       | ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚ºã¨è¦³æ¸¬ãƒã‚¤ã‚ºã®ç›¸é–¢ã‚’é™¤å» |
| ç™½è‰²åŒ– + Cholesky | æ®‹å·®ã‚’ç‹¬ç«‹ãƒ»åŒåˆ†æ•£åŒ–ã—ã¦é‡ã¿ä»˜ã‘å®¹æ˜“ã« |
| ã‚³ãƒ¬ãƒ³ãƒ­ãƒ”ãƒ¼é‡ã¿       | å¤–ã‚Œå€¤ã‚’æŒ‡æ•°çš„ã«æŠ‘åˆ¶ï¼ˆãƒ­ãƒã‚¹ãƒˆæ€§ï¼‰   |
| IRLS           | éç·šå½¢æœ€é©åŒ–ã‚’é€æ¬¡ç·šå½¢åŒ–ã—ã¦å®‰å®šåŒ–   |

---

# ğŸš€ ã¾ã¨ã‚ï¼šå®Œå…¨ç‰ˆMCKFã®å…¨ä½“æ§‹é€ 

$$
\boxed{
\begin{aligned}
&\text{â‘  Bernoulliãƒ¢ãƒ‡ãƒªãƒ³ã‚°} \rightarrow
\text{â‘¡ é…å»¶é™¤å»} \rightarrow
\text{â‘¢ ãƒ‡ã‚³ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³} \
&\rightarrow
\text{â‘£ KFäºˆæ¸¬} \rightarrow
\text{â‘¤ ç™½è‰²åŒ–ï¼‹ã‚³ãƒ¬ãƒ³ãƒ­ãƒ”ãƒ¼é‡ã¿ä»˜ã‘} \rightarrow
\text{â‘¥ IRLSæ›´æ–°}
\end{aligned}
}
$$

---

ã‚‚ã—å¸Œæœ›ãŒã‚ã‚Œã°ã€ã“ã®æ•°å¼ã‚»ãƒƒãƒˆã‚’ãã®ã¾ã¾ MATLAB / Python å®Ÿè£…ã«è½ã¨ã—è¾¼ã‚“ã ã€Œå®Œå…¨ç‰ˆ MCKFï¼ˆé…å»¶ã‚ã‚Šå¯¾å¿œï¼‰ã€é–¢æ•°ã¨ã—ã¦æä¾›ã§ãã¾ã™ã€‚
æ¬¡ã«é€²ã‚ã‚‹ã¨ã—ãŸã‚‰ã€**MATLABç‰ˆ**ã¨**Pythonï¼ˆNumPyï¼‰ç‰ˆ**ã®ã©ã¡ã‚‰ã«ã—ã¾ã™ã‹ï¼Ÿ
