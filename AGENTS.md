# Repository Guidelines

## プロジェクト構造とモジュール配置
このリポジトリは Python ベースの mosaik シナリオを中心に構成され、構造を理解すると拡張が容易になります。リポジトリ直下の `main.py` が orchestrator として各シミュレーターの生成、接続、スケジュールを管理します。`numerical_simulator.py` は正弦波生成の数値モデルを提供し、外部制御入力を受け取るためのフックも備えます。`hardware_simulator.py` では物理デバイスを模した I/O スタブが実装され、実機連携時はここを差し替えます。`data_collector.py` はテレメトリを収集して `simulation_data.h5` と標準出力に書き出し、解析パイプラインの起点となります。Web UI は `web_visualization/` ディレクトリにまとまり、`index.html` + `dashboard.js` + `style.css` の組み合わせでポート 8002 のリアルタイム表示を構築します。依存関係、lint、フォーマッタ設定は `pyproject.toml` で一元管理されるため、ライブラリ追加時はこのファイルと `uv.lock` を併せて更新してください。

## ビルド・テスト・開発コマンド
- `uv sync`: 依存関係をロックファイルに従って同期し、仮想環境を最新化します。CI でもこのコマンドを最初に実行する想定です。
- `uv run python main.py`: 完全なシミュレーションを実行し、Web ダッシュボードを起動、更新された `simulation_data.h5` を生成します。`--log-level DEBUG` を付けると詳細ログが得られます。
- `uv run ruff check .`: Ruff lint を実行し、未使用 import や 命名違反、バグパターンを検出します。CI での失敗を防ぐためコミット前に走らせてください。
- `uv run ruff format .`: コード整形を適用します。差分確認だけなら `--check` フラグ、CI 用には `--diff` を併用します。

## コーディングスタイルと命名規約
Python コードは 4 スペースインデントと行長 88 文字を標準とし、docstring を追加する際は Google style を推奨します。Ruff の `select` には `E`, `W`, `F`, `I`, `N`, `UP`, `B`, `A`, `C4`, `PL`, `RUF` が含まれているため、snake_case, PascalCase, CONSTANT_CASE の組み合わせを厳格に守ってください。文字列リテラルはダブルクォートが既定であり、フォーマットには f-string を優先します。副作用のある初期化子は `if __name__ == "__main__"` ブロック内に限定し、モジュールレベルでは設定値や dataclass の宣言だけを行います。型ヒントは public API とテスト対象部分に付与し、開発中は `from __future__ import annotations` の利用を検討してください。

## テストガイドライン
現状での最も信頼できる検証はエンドツーエンドシナリオです。`uv run python main.py` を実行し、ブラウザから `http://localhost:8002` にアクセスしてメトリクスが 1 秒間隔で更新されることを確認します。数値系のアルゴリズムを追加する際は純粋関数として抽出し、将来的な `tests/` ディレクトリで pytest を採用できる形を意識してください。シミュレーション結果のレグレッションを監視するため、`simulation_data.h5` を読み取って末尾エントリを比較するスクリプトを `scripts/` 配下に追加することを推奨します。ハードウェア連携コードは `hardware_simulator.py` に依存注入ポイントを設け、テスト時にはフェイクドライバを渡す設計にしてください。

## コミットとプルリクエスト方針
コミットメッセージは `type: summary` 形式で書き、`chore: format` の既存履歴と互換性を保ちます。`feat`, `fix`, `refactor`, `docs`, `test` などの Conventional Commits タイプを使い、範囲を明確にしてください。1 コミット 1 トピックを守り、依存関係更新やフォーマット変更は本体修正と切り離すとレビューがスムーズです。プルリクエストでは、目的、影響範囲、テスト結果、関連 Issue 番号を本文に箇条書きし、UI 変更時はスクリーンショットまたは短い GIF を添付します。ドラフト PR の段階でも Ruff チェックを通し、生成物（`simulation_data.h5` や キャッシュディレクトリ）を含めないよう `.gitignore` を確認してください。

## セキュリティと設定のヒント
Web 可視化はローカルネットワークに公開されるため、社外ネットワークで走らせる場合は SSH トンネルや VPN を経由し、ファイアウォールでポート 8002 を閉じたまま作業することを推奨します。実デバイス接続を行う場合、`hardware_simulator.py` のスタブを書き換えるのではなく、環境変数や設定ファイルからエンドポイントやシリアルポートを読み込むラッパーを新設してください。また、データ収集の保存先を変更する際は、`simulation_data.h5` を git 管理対象外に保つため `.gitignore` の更新を忘れないようにします。
初期トークンや API キーは `.env` に保存し、`uv run dotenv` などの補助ツールで読み込んでください。
